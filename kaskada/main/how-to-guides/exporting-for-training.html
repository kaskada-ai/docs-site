<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Kaskada Docs</title>
    <link rel="prev" href="../getting-started/hello-sharing-queries.html">
    <link rel="next" href="integrating-with-feature-stores.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../..">Kaskada Docs</a>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>
</header><div class="body">
<div class="nav-container" data-component="kaskada" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Kaskada Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting-started/hello-world.html">Hello World</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting-started/hello-client-setup.html">Client Setup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting-started/hello-loading-data.html">Loading Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting-started/hello-querying-data.html">Querying Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting-started/hello-sharing-queries.html">Sharing Queries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://colab.research.google.com/drive/1gPshkDfMQEb_DJ6qalGJVai-Uj0oV7zO?usp=sharing">Hello World Notebook (Collab)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://colab.research.google.com/drive/1dLK18pjf9puYZDuA_otIP3NvJYCUBSgR?usp=sharing">Customer Retention Demo Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://colab.research.google.com/drive/1eFcrgVGcV2skqNEiNDhV5DvCPwLmuqVs?usp=sharing">ML Workshop Demo (Colab)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://colab.research.google.com/drive/1Wg02zrxrJI_EEN8sAtoEXsRM7u8oDdBw?usp=sharing">Comparison of Fenl SQL Pandas (Colab)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How-To Guides</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="exporting-for-training.html">Exporting Features</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="integrating-with-feature-stores.html">Serving Features</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/client-authentication.html">Client Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/client-credentials.html">Client Credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/client-installation.html">Client Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/expected-file-format.html">Expected File Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/tables.html">Working with Tables</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/views.html">Working with Views</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/writing-queries.html">Writing Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/example-queries.html">Examples Queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/working-with-materializations.html">Working with Materializations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/working-with-slices.html">Working with Slices</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fenl</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fenl/fenl-quick-start.html">Fenl Quick Start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../fenl/language-guide.html">Fenl Language Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/data-model.html">Data model</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/syntax.html">Syntax</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/entities.html">Entities</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/temporal-aggregation.html">Temporal Computation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/aggregation-and-windowing.html">Aggregation and Windowing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../fenl/continuity.html">Continuity</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fenl/catalog.html">Fenl Catalog</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fenl/fenl-faq.html">Fenl FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../fenl/working-with-records.html">Working with Records</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kaskada Documentation</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Kaskada Documentation</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Kaskada Documentation</a></li>
    <li>How-To Guides</li>
    <li><a href="exporting-for-training.html">Exporting Features</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="example-modeling-problem"><a class="anchor" href="#example-modeling-problem"></a><a class="link" href="#example-modeling-problem">Example Modeling Problem</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll begin by laying out a simple modeling problem, based on the
<a href="../fenl/fenl-quick-start.html" class="xref page">Fenl Quickstart</a> guide. The goal will be to build a
model predicting if a given purchase will result in a fraud report
within the next 30 days given two event tables; a <code>Purchase</code> table and a
<code>FraudReport</code> table.</p>
</div>
<div class="sect2">
<h3 id="setup"><a class="anchor" href="#setup"></a><a class="link" href="#setup">Setup</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">table.create_table(
  table_name = "Purchase",
  time_column_name = "purchase_time",
  entity_key_column_name = "id",
  subsort_column_name = "subsort_id",
)
table.create_table(
  table_name = "PurchaseByCustomer",
  time_column_name = "purchase_time",
  entity_key_column_name = "customer_id",
  subsort_column_name = "subsort_id",
)
purchases_url = "https://drive.google.com/uc?export=download&amp;id=1SLdIw9uc0RGHY-eKzS30UBhN0NJtslkk"
purchases = pandas.read_parquet(purchases_url)
table.upload_dataframe("Purchase", purchases)
table.upload_dataframe("PurchaseByCustomer", purchases)

table.create_table(
  table_name = "FraudReport",
  time_column_name = "time",
  entity_key_column_name = "purchase_id",
  subsort_column_name = "subsort_id",
)
frauds_url = "https://drive.google.com/uc?export=download&amp;id=1WXRW1zt1EEPcbrw4nw9rCdhTqlatxTSR"
frauds = pandas.read_parquet(frauds_url)
table.upload_dataframe("FraudReport", frauds)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="feature-definitions"><a class="anchor" href="#feature-definitions"></a><a class="link" href="#feature-definitions">Feature Definitions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To train a model we must produce separate training and validation
datasets. These datasets will be created by partitioning the full set of
training examples into two time ranges, one spanning the years 2000-2015
and another spanning the years 2015-2020.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll execute the feature query twice, once to produce the training
dataset and another time to produce the validation dataset. The training
query will provide start and end times corresponding to the time
interval 2000-2015, while the validation query will times corresponding
to the time interval 2015-2020.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Usage</div>
<div class="paragraph">
<p>The fenlmagic extension is designed to make it easy to
interactively explore your dataset. When you&#8217;re ready time to train
model we recommend using the Python client. The python client exposes
the full functionality of the Kaskada API and is better-suited to tasks
such as managing Views, Tables, and making multiple queries with
different query variables.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-IPython hljs" data-lang="IPython">%%fenl --var examples

let average_purchase_by_customer = PurchaseByCustomer.amount
  | mean()

let predictors = {
    entity: Purchase.id,
    purchase_total: Purchase.amount | last(),
    mean_purchase: lookup(Purchase.customer_id, average_purchase_by_customer),
}
let target = {
  target: count(FraudReport),
}

let shifted =  predictors
  | shift_to(time_of($input) | add_time(days(30)))

in shifted | extend(lookup($input.entity, target))</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve provided the fenl-magic flag <code>--var examples</code> which causes the
query string to be assigned to a local variable named <code>examples</code>. We&#8217;ll
use this variable to create a view we can re-use when we make the
training and validation queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">from kaskada import view

view.create_view(
    view_name = "Examples",
    expression = examples,
)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="training-a-model-locally"><a class="anchor" href="#training-a-model-locally"></a><a class="link" href="#training-a-model-locally">Training a Model Locally</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Depending on the size of your training dataset and how you intend to
train a model, you may want to copy the training features locally or
transfer them to a remote data store. We&#8217;ll show the simple case of
training locally.</p>
</div>
<div class="paragraph">
<p>Begin by limiting the examples to the training time range.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-IPython hljs" data-lang="IPython">%%fenl

Examples
  | when time_of($input) &gt; ("2020-01-01T00:00:00Z" as timestamp_ns)
    and time_of($input) &lt;= ("2020-02-03T00:00:00Z" as timestamp_ns))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">training_resp = compute.query(
  query = """
  Examples
    | when(time_of($input) &gt; ("2020-01-01T00:00:00Z" as timestamp_ns)
      and time_of($input) &lt;= ("2020-02-03T00:00:00Z" as timestamp_ns))
  """,
)
training = pandas.read_parquet(training_resp.parquet.path, engine = "pyarrow")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we limit the examples to different time bounds to produce a
validation dataset.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-IPython hljs" data-lang="IPython">%%fenl

Examples
  | when time_of($input) &gt; ("2020-02-03T00:00:00Z" as timestamp_ns)
    and time_of($input) &lt;= ("2020-04-12T00:00:00Z" as timestamp_ns))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">validation_resp = compute.query(
  query = """
  Examples
    | when time_of($input) &gt; ("2020-02-03T00:00:00Z" as timestamp_ns)
    and time_of($input) &lt;= ("2020-04-01T00:00:00Z" as timestamp_ns))
  """,
)
validation = pandas.read_parquet(validation_resp.parquet.path, engine = "pyarrow")</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re finally ready to train a model. This shows a simple linear
regression model.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">from sklearn.linear_model import LogisticRegression
from sklearn import preprocessing

X_train = training.drop(['_time', '_subsort', '_key_hash', 'entity', 'target'], axis = 1)
y_train = training['target']
X_validation = validation.drop(['_time', '_subsort', '_key_hash', 'entity', 'target'], axis = 1)
y_validation = validation['target']

scaler = preprocessing.StandardScaler().fit(X_train)
X_train_scaled = scaler.transform(X_train)
X_validation_scaled = scaler.transform(X_validation)

model = LogisticRegression(max_iter=1000)
model.fit(X_train_scaled, y_train)

model.score(X_validation_scaled, y_validation)</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../getting-started/hello-sharing-queries.html">Sharing Queries</a></span>
  <span class="next"><a href="integrating-with-feature-stores.html">Serving Features</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
&copy; Copyright The Kaskada Authors 
</footer><script src="../../../_/js/site.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="../../../_/js/vendor/fenl.min.js"></script>
<script>hljs.highlightAll();</script>
  </body>
</html>
